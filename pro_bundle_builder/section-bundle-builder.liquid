{% schema %}
{
  "name": "Pro Bundle Builder",
  "settings": [
    {
      "type": "textarea",
      "id": "bundle_config",
      "label": "Bundle Config JSON",
      "info": "Paste the JSON output from `tools/bundle_config_generator.py` here."
    },
    {
      "type": "color",
      "id": "primary_color",
      "label": "Primary Color",
      "default": "#3b82f6"
    }
  ],
  "presets": [
    {
      "name": "Pro Bundle Builder"
    }
  ]
}
{% endschema %}

{%- style -%}
  .bundle-builder-root {
    --primary-color: {{ section.settings.primary_color }};
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    max-width: 1200px;
    margin: 40px auto;
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 40px;
    padding: 0 20px;
  }

  @media (max-width: 900px) {
    .bundle-builder-root {
      grid-template-columns: 1fr;
    }
  }

  /* Main Area */
  .bb-main { }

  .bb-progress {
    display: flex;
    justify-content: space-between;
    margin-bottom: 30px;
    position: relative;
  }
  .bb-progress::after {
    content: '';
    position: absolute;
    top: 15px;
    left: 0;
    width: 100%;
    height: 2px;
    background: #e5e7eb;
    z-index: 1;
  }

  .bb-step-dot {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #fff;
    border: 2px solid #e5e7eb;
    z-index: 2;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #9ca3af;
  }
  .bb-step-dot.active {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }
  .bb-step-dot.completed {
    background: var(--primary-color);
    border-color: var(--primary-color);
    color: white;
  }

  .bb-step-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 20px;
  }

  .bb-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 20px;
  }

  .bb-card {
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.2s;
    cursor: pointer;
  }
  .bb-card:hover {
    border-color: var(--primary-color);
  }
  .bb-card.selected {
    border-color: var(--primary-color);
    background-color: rgba(59, 130, 246, 0.05);
    box-shadow: 0 0 0 2px var(--primary-color);
  }

  .bb-card-img {
    width: 100%;
    height: 150px;
    background: #f3f4f6;
    margin-bottom: 10px;
    object-fit: cover;
    border-radius: 4px;
  }

  .bb-card-title {
    font-weight: 600;
    margin-bottom: 5px;
  }
  .bb-card-price {
    color: #6b7280;
    font-size: 0.9rem;
  }
  
  .bb-btn-add {
    margin-top: 10px;
    width: 100%;
    padding: 8px;
    background: white;
    border: 1px solid var(--primary-color);
    color: var(--primary-color);
    font-weight: 600;
    border-radius: 4px;
    cursor: pointer;
  }
  .bb-card.selected .bb-btn-add {
    background: var(--primary-color);
    color: white;
  }

  /* Sidebar */
  .bb-sidebar {
    background: #f9fafb;
    padding: 25px;
    border-radius: 12px;
    height: fit-content;
    position: sticky;
    top: 20px;
  }

  .bb-summary-title {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 15px;
  }

  .bb-cart-items {
    margin-bottom: 20px;
    min-height: 100px;
  }
  .bb-cart-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    font-size: 0.9rem;
  }

  .bb-total-row {
    display: flex;
    justify-content: space-between;
    font-weight: 700;
    font-size: 1.1rem;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e5e7eb;
  }

  .bb-checkout-btn {
    width: 100%;
    padding: 15px;
    background: var(--primary-color);
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 6px;
    margin-top: 20px;
    cursor: pointer;
    font-size: 1rem;
  }
  .bb-checkout-btn:disabled {
    background: #d1d5db;
    cursor: not-allowed;
  }

{%- endstyle -%}

<div id="bundle-builder-app" class="bundle-builder-root">
    <!-- Rendered by JS -->
    <div class="bb-main">Loading Builder...</div>
    <div class="bb-side"></div>
</div>

<script>
class BundleBuilder {
  constructor(config, containerId) {
    this.config = config;
    this.container = document.getElementById(containerId);
    this.state = {
      currentStep: 0,
      selections: {} // { step_id: [item_id, item_id] }
    };
    
    this.init();
  }

  init() {
    this.render();
  }

  formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }

  toggleItem(stepId, itemId) {
    const step = this.config.steps.find(s => s.step_id === stepId);
    let currentSelection = this.state.selections[stepId] || [];

    if (currentSelection.includes(itemId)) {
      // Remove
      currentSelection = currentSelection.filter(id => id !== itemId);
    } else {
      // Add
      if (!step.allow_multiple) {
        currentSelection = [itemId];
      } else {
        currentSelection.push(itemId);
      }
    }
    
    this.state.selections[stepId] = currentSelection;
    this.render();
  }

  getTotalPrice() {
    let total = 0;
    let itemCount = 0;
    
    Object.keys(this.state.selections).forEach(stepId => {
      const step = this.config.steps.find(s => s.step_id == stepId);
      const selectedIds = this.state.selections[stepId];
      if(!selectedIds) return;

      selectedIds.forEach(id => {
        const item = step.items.find(i => i.id == id);
        if(item) {
            total += item.price;
            itemCount++;
        }
      });
    });

    // Apply Discount
    let discount = 0;
    if(this.config.discount_tiers) {
        // Sort tiers by quantity desc
        const tiers = [...this.config.discount_tiers].sort((a,b) => b.quantity - a.quantity);
        for(let tier of tiers) {
            if(itemCount >= tier.quantity) {
                discount = total * (tier.discount_percentage / 100);
                break;
            }
        }
    }

    return { total, discount, final: total - discount, itemCount };
  }

  async addToCart() {
    const itemsToAdd = [];
    Object.values(this.state.selections).flat().forEach(id => {
        itemsToAdd.push({ id: id, quantity: 1 });
    });

    try {
        const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: itemsToAdd })
        });
        
        if(response.ok) {
            window.location.href = '/cart';
        } else {
            alert('Error adding items to cart');
        }
    } catch(e) {
        console.error(e);
        alert('Network error');
    }
  }

  render() {
    if(!this.config) {
        this.container.innerHTML = "<div>Error: No Configuration Found. Please paste JSON in section settings.</div>";
        return;
    }

    const currentStepConfig = this.config.steps[this.state.currentStep];
    const { total, discount, final, itemCount } = this.getTotalPrice();

    // 1. Progress Bar
    const progressHtml = `
      <div class="bb-progress">
        ${this.config.steps.map((s, idx) => `
          <div class="bb-step-dot 
            ${idx === this.state.currentStep ? 'active' : ''} 
            ${idx < this.state.currentStep ? 'completed' : ''}">
            ${idx + 1}
          </div>
        `).join('')}
      </div>
    `;

    // 2. Step Content
    const stepHtml = `
      <h2 class="bb-step-title">${currentStepConfig.title}</h2>
      <div class="bb-grid">
        ${currentStepConfig.items.map(item => {
            const isSelected = (this.state.selections[currentStepConfig.step_id] || []).includes(item.id);
            return `
            <div class="bb-card ${isSelected ? 'selected' : ''}" 
                 onclick="app.toggleItem(${currentStepConfig.step_id}, ${item.id})">
               <div class="bb-card-img" style="background-image:src('${item.image}')">
                 <!-- Placeholder logic for demo -->
                 <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#ccc;">IMG</div>
               </div>
               <div class="bb-card-title">${item.name}</div>
               <div class="bb-card-price">${this.formatMoney(item.price)}</div>
               <button class="bb-btn-add">${isSelected ? 'Selected' : 'Add'}</button>
            </div>
            `;
        }).join('')}
      </div>
      
      <div style="margin-top:20px; display:flex; gap:10px;">
        ${this.state.currentStep > 0 ? 
            `<button onclick="app.state.currentStep--; app.render()" style="padding:10px; cursor:pointer;">&larr; Back</button>` : ''}
        
        ${this.state.currentStep < this.config.steps.length - 1 ? 
            `<button onclick="app.state.currentStep++; app.render()" style="padding:10px 20px; background:#333; color:white; border:none; cursor:pointer; border-radius:4px;">Next Step &rarr;</button>` : ''}
      </div>
    `;

    // 3. Sidebar
    const sidebarHtml = `
      <div class="bb-sidebar">
        <div class="bb-summary-title">Your Bundle</div>
        <div class="bb-cart-items">
             ${Object.keys(this.state.selections).map(sid => {
                 const step = this.config.steps.find(s => s.step_id == sid);
                 if(!step) return '';
                 return this.state.selections[sid].map(iid => {
                     const item = step.items.find(i => i.id == iid);
                     return `<div class="bb-cart-item"><span>${item.name}</span><span>${this.formatMoney(item.price)}</span></div>`
                 }).join('');
             }).join('')}
        </div>
        
        <div class="bb-total-row">
            <span>Subtotal</span>
            <span>${this.formatMoney(total)}</span>
        </div>
        ${discount > 0 ? `
            <div class="bb-total-row" style="color:green; font-size:0.9rem; margin-top:5px; padding-top:0; border:none;">
                <span>Discount</span>
                <span>-${this.formatMoney(discount)}</span>
            </div>
        ` : ''}
        <div class="bb-total-row" style="font-size:1.5rem;">
            <span>Total</span>
            <span>${this.formatMoney(final)}</span>
        </div>

        <button class="bb-checkout-btn" 
            onclick="app.addToCart()" 
            ${itemCount === 0 ? 'disabled' : ''}>
            Add Bundle to Cart
        </button>
      </div>
    `;

    this.container.innerHTML = `
        <div class="bb-main">
            ${progressHtml}
            ${stepHtml}
        </div>
        ${sidebarHtml}
    `;
  }
}

document.addEventListener('DOMContentLoaded', () => {
    // In production, this would come from section settings
    // For now, we will try to parse the setting, or fallback to a demo config if empty
    let configData = null;
    const rawConfig = `{{ section.settings.bundle_config }}`;
    
    if(rawConfig && rawConfig.trim() !== '') {
        try {
            configData = JSON.parse(rawConfig);
        } catch(e) {
            console.error("Invalid JSON Config", e);
        }
    }
    
    // Fallback Demo Data if user hasn't configured it yet
    if(!configData) {
        configData = {
           "steps": [
               {
                   "step_id": 1,
                   "title": "Config Required",
                   "items": []
               }
           ]
        };
        // We can show a message instead of breaking
        document.getElementById('bundle-builder-app').innerHTML = `
            <div style="text-align:center; padding: 50px;">
                <h2>Setup Required</h2>
                <p>Please use <code>tools/bundle_config_generator.py</code> to generate your config and paste it into the section settings.</p>
            </div>
        `;
        return;
    }

    window.app = new BundleBuilder(configData, 'bundle-builder-app');
});
</script>
