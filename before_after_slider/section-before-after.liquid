{% schema %}
{
  "name": "Before/After Slider",
  "settings": [
    {
      "type": "header",
      "content": "Images"
    },
    {
      "type": "image_picker",
      "id": "image_before",
      "label": "Before Image"
    },
    {
      "type": "image_picker",
      "id": "image_after",
      "label": "After Image"
    },
    {
      "type": "header",
      "content": "Settings"
    },
    {
      "type": "color",
      "id": "handle_color",
      "label": "Handle Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "section_height",
      "min": 300,
      "max": 800,
      "step": 10,
      "unit": "px",
      "label": "Section Height",
      "default": 600
    },
    {
      "type": "range",
      "id": "initial_offset",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "%",
      "label": "Initial Slider Position",
      "default": 50
    }
  ],
  "presets": [
    {
      "name": "Before/After Slider"
    }
  ]
}
{% endschema %}

{%- style -%}
  .ba-slider-section-{{ section.id }} {
    position: relative;
    width: 100%;
    height: {{ section.settings.section_height }}px;
    overflow: hidden;
    user-select: none;
    -webkit-user-select: none;
  }

  /* Responsive height for mobile */
  @media (max-width: 768px) {
    .ba-slider-section-{{ section.id }} {
      height: 400px;
    }
  }

  .ba-container {
    position: absolute;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .ba-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
  }

  /* The 'After' image (top layer) gets clipped */
  .ba-after-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    width: 100%; /* Initially full width, clipped by parent width in JS? No, easier to change width of container */
    width: {{ section.settings.initial_offset }}%;
    overflow: hidden;
    z-index: 2;
    border-right: 2px solid {{ section.settings.handle_color }};
    box-shadow: 2px 0 10px rgba(0,0,0,0.2);
  }

  .ba-after-wrapper .ba-img {
    /* Important: Image needs to stay full width relative to SECTION, not wrapper */
    width: 100vw; 
    max-width: none; 
    /* To keep it aligned we might need JS or fixed width container logic. 
       Better approach: BOTH images are background images or absolute full width. 
       If wrapper reduces width, child img reduces width... UNLESS child img is fixed width. 
    */
    width: inherit; /* Wait, this will squash. */
  }

  /* Better styling approach: 
     Section Relative.
     Img Before: absolute, full w/h.
     Img After Wrapper: absolute, full height, variable width, overflow hidden.
     Img After: absolute, full HEIGHT, but WIDTH must match SECTION WIDTH to align pixels.
  */
  
  .ba-after-wrapper .ba-img-inner {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      /* This needs to be set to the width of the parent container via JS on resize */
      width: 100vw; 
      /* Fallback/Start */
  }

  .ba-handle {
    position: absolute;
    top: 50%;
    right: -20px; /* Center the 40px handle on the border */
    width: 40px;
    height: 40px;
    background: {{ section.settings.handle_color }};
    border-radius: 50%;
    transform: translateY(-50%);
    z-index: 3;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: ew-resize;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }

  .ba-handle svg {
    width: 24px;
    height: 24px;
    fill: #333;
  }

{%- endstyle -%}

<div class="ba-slider-section-{{ section.id }}" id="ba-slider-{{ section.id }}">
  <!-- Before Image (Background) -->
  <div class="ba-container ba-before">
      {% if section.settings.image_before %}
        {{ section.settings.image_before | image_url: width: 2000 | image_tag: loading: 'lazy', class: 'ba-img' }}
      {% else %}
        {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg ba-img' }}
      {% endif %}
  </div>

  <!-- After Image (Foreground, Clipped) -->
  <div class="ba-after-wrapper" id="ba-after-{{ section.id }}">
      <div class="ba-img-inner" id="ba-inner-{{ section.id }}">
        {% if section.settings.image_after %}
            {{ section.settings.image_after | image_url: width: 2000 | image_tag: loading: 'lazy', class: 'ba-img' }}
        {% else %}
            {{ 'lifestyle-2' | placeholder_svg_tag: 'placeholder-svg ba-img' }}
        {% endif %}
      </div>
      
      <!-- Handle -->
      <div class="ba-handle">
        <svg viewBox="0 0 24 24"><path d="M8 19l-5-7 5-7v14zm8-14l5 7-5 7V5z"/></svg>
      </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const slider = document.getElementById('ba-slider-{{ section.id }}');
  const afterWrapper = document.getElementById('ba-after-{{ section.id }}');
  const innerImgContainer = document.getElementById('ba-inner-{{ section.id }}');
  const innerImg = innerImgContainer.querySelector('img') || innerImgContainer.querySelector('svg');
  
  let isDown = false;

  function updateDimensions() {
    const width = slider.offsetWidth;
    // Set the inner image container directly to the slider's full width
    // This ensures the two images overlay perfectly regardless of the wrapper's width
    innerImgContainer.style.width = width + 'px';
    if(innerImg) {
        innerImg.style.width = width + 'px';
        innerImg.style.height = '100%';
        innerImg.style.objectFit = 'cover';
    }
  }

  function move(e) {
    if (!isDown) return;
    
    // Get cursor position (touch or mouse)
    let clientX = e.clientX || (e.touches && e.touches[0].clientX);
    
    const rect = slider.getBoundingClientRect();
    let x = clientX - rect.left;
    
    // Clamp
    if (x < 0) x = 0;
    if (x > rect.width) x = rect.width;
    
    const percent = (x / rect.width) * 100;
    afterWrapper.style.width = percent + "%";
  }

  // Mouse Events
  slider.addEventListener('mousedown', function(e) { isDown = true; });
  window.addEventListener('mouseup', function(e) { isDown = false; });
  slider.addEventListener('mousemove', move);

  // Touch Events
  slider.addEventListener('touchstart', function(e) { isDown = true; });
  window.addEventListener('touchend', function(e) { isDown = false; });
  slider.addEventListener('touchmove', move);

  // Init
  window.addEventListener('resize', updateDimensions);
  updateDimensions();
  // Call again after a momentary delay to ensure images loaded
  setTimeout(updateDimensions, 1000);
});
</script>
